---
title: "MultivarTV-introduction"
author: "Brayan Ortiz"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteKeywords{R, C++, Armadillo, total variation, thin plate splines, denoising, piece-wise constant signals, signal processing}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r libsetup, include = FALSE, echo=FALSE}
library(plot3D)
library(fields)
library(MultivarTV)
# Towers function
towers <- function(x1,x2){
	n=length(x1)
	y = numeric(n)
	for (i in 1:n){ 
		y[i] = 1*(x1[i]>0.8)*1*(x2[i]>0.8)+0.5*1*(x1[i]>0.8)*1*(x2[i]<0.2)+1*1*(x1[i]<0.2)*1*(x2[i]<0.2)+0.5*1*(x1[i]<0.2)*1*(x2[i]>0.8)
	}
	return(y)
}
```

## Abstract


## Introduction

1. statistical problem of fitting functions. how do we do it? 
2. denoising are one way. what problems motivate using total variation solution?
3. why is that solution hard to get? when is it easy to get?
4. our approach to mvtv

## MultivarTV Demo

### Towers Function

We want to fit any multivariate surface as the solution to a total variation problem. One surface that we can use for demonstration is one that resembles four towers on a plain. In Figure 1, we plot the towers as a mesh and overlay points generated from the towers function with noise. 

```{r ,eval=FALSE}
# Note that we use gen_mesh() in MultivarTV package to generate function.
dat <- seq(0+0.0001,1-0.0001,length.out = 5)
mat <- cbind(dat,dat)
m <- matrix(rep(30,2),ncol=1)
dataMesh <- gen_mesh(mat,m,NULL )
y <- towers(dataMesh[,1],dataMesh[,2])
set.seed(117)
ynoisy <- y + rnorm(length(y),0,0.1)
```


```{r fig1, echo=FALSE, fig.cap = "Figure 1. Plot of N=100 points drawn from Towers function (drawn as mesh) with noise.", fig.width=4, fig.height = 4}
x1 <- seq(0,1,length.out=40); x2 <- x1
x1x2 <- expand.grid(x1,x2)
z <- matrix(towers(x1x2[,1],x1x2[,2]),nrow=40,ncol = 40)
#y <- outer(x1,x2,towers)
set.seed(117)
z1 <- runif(100)
z2 <- runif(100)
z3 <- towers(z1,z2)
ynoisy <- z3 + rnorm(length(z3),0,0.5)

scatter3D(z1,z2,ynoisy,theta=30,phi=30,xlab="x1",ylab="x2",zlab="y",cex=1,pch=20,
          surf= list(x = x1,y = x2,z = z,facets=NA,fit = z3))

```


The noisy towers can be fit well by a total variation solution. In this example, we will also compare the total variation fit against a thin plate spline. Based on Figure 2, we indeed get a jagged sombrero for our total variation solution. In Figure 3, we see the thin plate spline solution, which is much more smooth and perhaps introduces too much wiggliness along the ridges of the sombrero. When we increase the noise (from $\sigma=0.1$ to $\sigma=0.5$), thin plate splines behave similarly as before (Figure 5), while the total variation solution has more regularization (Figure 4). This contrast illustrates how a denoising solution will tend to behave in the presence of large amounts of noise, i.e. more regularity will be introduced in the solution. However, this does not mean that the fit is necessarily better or worse. Next, we investigate how the total variation solution compares to the thin plate spline in simulation. 


```{r figure2, echo=TRUE, fig.cap="Figure 2. Total variation solution for noisy sombrero." , fig.width=5, fig.height = 7}
set.seed(117)
mym <- matrix(rep(sqrt(length(ynoisy)),2),ncol=1)
data <- cbind(z1,z2)
tvmod <- mvtv(data,ynoisy,mym,verbose=FALSE)
plot(tvmod,adddata = TRUE)
```


```{r figure3,echo=TRUE, fig.cap="Figure 3. Thin plate spline solution for noisy sombrero." , fig.width=5, fig.height = 7}
fit <- Tps(data,ynoisy)
out.p <- predictSurface(fit, xy = c(1,2))
plot.surface(out.p, type="p")
```


```{r figure4, echo=TRUE, fig.cap="Figure 4. Total variation solution for noisier sombrero.", fig.width=5, fig.height = 7}
set.seed(117)
ynoisy2 <- z3 + rnorm(length(z3),0,0.5)

set.seed(117)
tvmod2 <- mvtv(data,ynoisy2,mym,verbose=FALSE)
plot(tvmod,adddata = TRUE)
```


```{r figure5,echo=TRUE, fig.cap="Figure 5. Thin plate spline solution for noisier sombrero.", fig.width=5, fig.height = 7}
fit2 <- Tps(data,ynoisy2)
out.p2 <- predictSurface(fit2, xy = c(1,2))
plot.surface(out.p2, type="p")
```

## Conclusions
